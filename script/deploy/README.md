# Deployment

This document provides instructions on how to perform deployments using the available scripts.

## Tasks

### Generating Test Salts

Many of the tests use salts to deploy callbacks at addresses with a specific prefix. Changes to the state variables in the test contract can require the re-generation of the salt. To do so, perform the following:

```bash
./script/deploy/test_salts.sh
```

The resulting salts will be written to the `./script/salts.json` file, which the test cases will read from.

Notes:

- When re-generating salts, ensure that any git submodule changes are either reverted or committed. For example, if switching from a branch with a particular submodule to a branch in which that submodule is not present, the submodule changes will not be automatically reverted. This will cause changes in the generated bytecode and in turn, the salt. The submodule changes must be reverted and the salts generated afterwards.

### Generating AuctionHouse Salts

For aesthetic reasons, the AuctionHouse contracts may need to be deployed at deterministic addresses.

For the AtomicAuctionHouse and BatchAuctionHouse, a specific script can be used to generate the addresses with a desired prefix.

Assuming that the developer wants to deploy an AtomicAuctionHouse at an address that will start with `0xAA` and will be stored in the salts file using the key `AtomicAuctionHouseV1`, the following command would be run:

```bash
./script/deploy/auction_house_salts.sh atomic AA AtomicAuctionHouseV1
```

The generated salt would be stored in `./script/salts.json`.

The salt key can then be added into the deployment-specific sequence file under `./script/deploy/sequences/`. For example:

```json
{
    "sequence": [
        {
            "name": "AtomicAuctionHouse",
            "args": {},
            "saltKey": "AtomicAuctionHouseV1"
        }
    ]
}
```

Provided the bytecode is the same, the same salt key can be used to deploy the contract at the same address on different chains.

### Generating Salts for Any Contract

For aesthetic, gas or other reasons, certain contracts will need to be deployed at deterministic addresses.

The following steps need to be followed to generate the salt:

1. Generate the bytecode file and write it to disk. For example:

```solidity
        bytes memory bytecode = abi.encodePacked(
            type(MockCallback).creationCode,
            abi.encode(address(_auctionHouse), Callbacks.Permissions({
                onCreate: true,
                onCancel: false,
                onCurate: false,
                onPurchase: true,
                onBid: true,
                onClaimProceeds: false,
                receiveQuoteTokens: false,
                sendBaseTokens: false
            }), _SELLER)
        );
        vm.writeFile(
            "./bytecode/MockCallback98.bin",
            vm.toString(bytecode)
        );
```

1. Run the salts script with the desired prefix. For example:

```bash
./scripts/deploy/salts.sh ./bytecode/MockCallback98.bin "98"
```

1. The salt can then be added into the deployment-specific sequence file under `./script/deploy/sequences/`. For example:

```json
{
    "sequence": [
        {
            "name": "MockCallback",
            "args": {},
            "saltKey": "MockCallback98"
        }
    ]
}
```

### Contract Deployment

There is a deployment script that can be used to deploy any contract for the Axis system.

#### Environment

The `./script/env.json` file contains a per-chain definition of common addresses. These should be populated before deploying to new chains.

#### Sequences

Sequences are JSON files located under the `./script/deploy/sequences/` directory that specify the _sequence_ in which a set of contracts (with their respective arguments and salts) should be deployed.

Notes:

- If an AuctionHouse-derived contract is to be deployed, it must be the first in order.
- If a second AuctionHouse-derived contract is to be deployed, it must be the second in order.
- Supported entry keys:
  - `name`: The `name` field corresponds to the function in `Deploy.s.sol` that will be used.
  - `args`: A dictionary, in alphabetical order, of arguments that will be provided to the deployment function.
  - `saltKey`: An optional string that contains the key for the salt (located in `./script/salts.json`) that will be used to deploy the contract at a deterministic address.
  - `installAtomicAuctionHouse`: An optional boolean that indicates whether the module should be installed in the AtomicAuctionHouse contract.
  - `installBatchAuctionHouse`: An optional boolean that indicates whether the module should be installed in the BatchAuctionHouse contract.

#### Adding A Contract

First, support for the contract needs to be added in the deployment script, `./script/deploy/Deploy.s.sol`.

This involves creating a function in the format of `function deploy<key>(bytes memory args_, bytes32 salt_) public virtual returns (address)`.

For example, a deployment with `name` set to "AtomicLinearVesting" would require a function to be present in `Deploy.s.sol` with the name `deployAtomicLinearVesting`.

This function should take in the args and salt, in addition to the environment variables, and deploy the contract.

#### Running the Deployment

To perform a deployment, run the following script:

```bash
./script/deploy/deploy.sh < sequence_file > [broadcast=false] [verify=false] [resume=false]
```

For example, the following command will deploy using the specified sequence file, broadcast the changes and verify them using Etherscan:

```bash
./script/deploy/deploy.sh ./script/deploy/sequences/auctionhouse-mainnet.json true true
```

Following deployment, the addresses need to be manually added into `./script/env.json`.

##### Blast-Specific Version

Deploying on Blast requires an AuctionHouse with additional constructor arguments. For this reason, the `DeployBlast.s.sol` contract script exists, which overrides the deployment behaviour of some contracts.

Example command:

```bash
DEPLOY_SCRIPT="./script/deploy/DeployBlast.s.sol" DEPLOY_CONTRACT="DeployBlast" ./script/deploy/deploy.sh ./script/deploy/sequences/auctionhouse-mainnet.json true true
```
